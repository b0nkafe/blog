<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<style type=text/css>body{font-family:monospace;}</style>
	<title>Cirugía Retro</title>
	
	
	<link rel="stylesheet" href="/css/style.css">
	
</head>
<body>
	<header>
	<pre id="header">
		
:::::::.      ...   :::.    :::. :::  .    .:
;;;'';;'  .;;;;;;;.`;;;;,  `;;; ;;; .;;,.;;;
[[[__[[\.,[[     \[[,[[[[[. '[[ [[[[[/'  '[[
$$""""Y$$$$$,     $$$$$$ "Y$c$$_$$$$,     $$
_88o,,od8P"888,_ _,88P888    Y88"888"88o,  ""
""YUMMMP"   "YMMMMMP" MMM     YM MMM "MMP" MM
	</pre>
	<div style="float: right;"></div><br>
	<nav id="menu">
			<a href="/"><b>$HOME</b></a> | <a href="https://paypal.me/b0nkafe">INVÍTAME A UN CAFÉ</a>
			
</header>

	
	<main>
		<article>
			<h1>Cirugía Retro</h1>
			<b><time>30.06.2020 21:01</time></b> |
		       tags: 
		           <a href="/tags/atari-st">Atari ST</a>
        	       
			<div id="post">
				<h3 id="intro">Intro</h3>
<p>Replicando a la Wikipedia, <strong><em>&ldquo;Cruise for a Corpse&rdquo;</em></strong> es una aventura gráfica de <a href="https://es.wikipedia.org/wiki/Delphine_Software">Delphine Software</a> desarrollado para Atari ST, Amiga y PC allá por 1991. Hasta donde se sabe, el juego estaba disponible en varios idiomas en las distintas plataformas: Inglés, Alemán, Francés (como <strong><em>&ldquo;Croisière pour un Cadavre&rdquo;</em></strong>) y Español.</p>
<p>A estas alturas, casi 30 años después me dió por buscar grupos de <a href="https://t.me/comunidad_atari">Telegram sobre Atari</a> debido a varias cosillas sin relación con el juego:</p>
<ol>
<li>Me explotó el monitor (SC1224) :(</li>
<li>Quería intentar preservar los discos que tengo y quería consultar opciones.</li>
</ol>
<p>Total, que hablando de todo un poco, se dice, se comenta, que están preservadas todas las versiones para todas las plataformas en todos los idiomas&hellip; menos la versión española para Atari ST. Parece ser que la comunidad llevaba <a href="http://www.retrowiki.es/viewtopic.php?f=39&amp;t=224">varios años detrás de ella</a>. Ahí fué cuando se me encendió una bombillita. Ya que estaba preguntando por temas de preservación, me decidí a ponerle solución, por lo que me puse a indagar sobre el juego.</p>
<p>Y aquí es donde empieza mi aventura.</p>
<p>Antes de empezar a daros la chapa, quisiera agradecer desde aquí a <a href="https://wiki.scummvm.org/index.php?title=User:Sev">Eugene &lsquo;sev&rsquo; Sandulenko</a> del equipo de desarrollo de ScummVM tanto por ayudarme a resolver algunas dudas sobre el funcionamiento del motor del juego como por aguantarme durante las pruebas realizadas en el desarrollo de las herramientas utilizadas durante este proceso para reempaquetar los ficheros y localizar algunos errores.</p>
<p>A <a href="https://wiki.scummvm.org/index.php/User:Buddha%5E">Kari &lsquo;Buddha^&rsquo; Salminen</a> por el trabajo previo que realizó sobre el motor Cinématique, usado por otro juego de Delphine Software llamado Operation Stealth.</p>
<p>A <a href="https://t.me/comunidad_atari">Comunidad Atari</a> por el apoyo que he recibido durante el proceso y por aguantar mis monólogos sobre este tema :)</p>
<p>Y lo más importante, a mi família por aguantar mis <em>&ldquo;friquerías&rdquo;</em> <strong>&lt;3</strong></p>
<h2 id="recon">Recon</h2>
<p>Como soy un tío medio metódico (NOPE, muahaha!), la primera fase la dediqué al reconocimiento. Tanto de las versiones preservadas como desarrollos / investigaciones llevadas a cabo por otros en el pasado en relación al juego o al motor. Los objetivos que me marqué eran los siguientes:</p>
<ul>
<li>Confirmar que la versión española para Atari ST no estaba preservada.</li>
<li>Averiguar si los ficheros de recursos del juego se podían extraer de manera relativamente simple.</li>
<li>Averiguar si alguien había intentado reversear / &ldquo;meterle mano&rdquo; al juego.</li>
<li>Recopilar toda la información posible acerca del motor utilizado en el juego.</li>
</ul>
<p>Respecto al primer punto&hellip; efectivamente, parece que no está preservada la versión en español para Atari ST. En cuanto al resto de puntos, os lo cuento en detalle en las siguientes líneas, pero parece ser que entre 2008 y 2009 los motores utilizados por las aventuras gráficas de <a href="https://es.wikipedia.org/wiki/Delphine_Software">Delphine Software</a> fueron <em>víctimas</em> de un proceso de ingeniería inversa y portados a <a href="https://www.scummvm.org/">ScummVM</a>. Por suerte, bastantes características de dichos motores fueron detalladas por desarrolladores de ScummVM.</p>
<p>En las siguientes líneas paso a detallar cómo empecé a desengranar el juego.</p>
<h2 id="aglutinando-versiones">Aglutinando versiones</h2>
<p>El primer paso era conseguir las copias del juego que había disponibles. Me hice con las siguientes versiones:</p>
<table>
<thead>
<tr>
<th>Plataforma</th>
<th>Idioma</th>
<th>Crackeada</th>
</tr>
</thead>
<tbody>
<tr>
<td>Amiga</td>
<td>Español</td>
<td>Sí</td>
</tr>
<tr>
<td>Atari ST</td>
<td>Alemán</td>
<td>Sí</td>
</tr>
<tr>
<td>Atari ST</td>
<td>Francés</td>
<td>No</td>
</tr>
<tr>
<td>PC VGA</td>
<td>Español</td>
<td>Sí</td>
</tr>
</tbody>
</table>
<p>El hecho de que esté crackeada influirá en el repacking del juego, como veremos más adelante. Los cracks que he visto sobre el juego tocan tanto el ejecutable <code>CRUISE.PRG</code> como los ficheros de recursos que se usa durante el proceso de protección. Así pues, a efectos de preservación, consideraba imprescindible obtener una copia del juego intacta.</p>
<p>El paso siguiente sería echar un vistazo a los ficheros del juego y empezar a &ldquo;abrir&rdquo; cosas, muahaha! :}</p>
<h2 id="análisis-de-ficheros-y-unpacking">Análisis de ficheros y unpacking</h2>
<p>Parece ser que el juego se distribuía en 5 floppies. El listado de ficheros es el siguiente:</p>
<table>
<thead>
<tr>
<th>Disco</th>
<th>Fichero</th>
<th>Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td><code>AUTO/CRUISE.PRG</code></td>
<td>Ejecutable del juego, en el directorio <code>AUTO</code> para que arranque desde disco.</td>
</tr>
<tr>
<td>A</td>
<td><code>D1</code></td>
<td>Volumen de recursos del primer disco.</td>
</tr>
<tr>
<td>A</td>
<td><code>INSTALL.PRG</code></td>
<td>Ejecutable para configurar el audio del juego.</td>
</tr>
<tr>
<td>A</td>
<td><code>MIDI.OFF</code></td>
<td>Fichero de configuración de sonido.</td>
</tr>
<tr>
<td>A</td>
<td><code>READ.ME</code></td>
<td>Fichero <em>README</em> con instrucciones de instalación.</td>
</tr>
<tr>
<td>A</td>
<td><code>SYSTEM.FNT</code></td>
<td>Fichero de la <a href="https://en.wikipedia.org/wiki/Computer_font#Bitmap_fonts">raster font</a> del juego.</td>
</tr>
<tr>
<td>A</td>
<td><code>VOL.1</code></td>
<td>Fichero identificador del primer volumen de recursos.</td>
</tr>
<tr>
<td>A</td>
<td><code>VOL.CNF</code></td>
<td>Volumen <em>maestro</em> de recursos. Tiene un índice general del contenido de todos los volúmenes.</td>
</tr>
<tr>
<td>B</td>
<td><code>D2</code></td>
<td>Volumen de recursos del segundo disco.</td>
</tr>
<tr>
<td>B</td>
<td><code>VOL.2</code></td>
<td>Identificador del segundo volumen de recursos.</td>
</tr>
<tr>
<td>C</td>
<td><code>D3</code></td>
<td>Volumen de recursos del tercer disco.</td>
</tr>
<tr>
<td>C</td>
<td><code>VOL.3</code></td>
<td>Identificador del tercer volumen de recursos.</td>
</tr>
<tr>
<td>D</td>
<td><code>D4</code></td>
<td>Volumen de recursos del cuarto disco.</td>
</tr>
<tr>
<td>D</td>
<td><code>VOL.4</code></td>
<td>Identificador del cuarto volumen de recursos.</td>
</tr>
<tr>
<td>E</td>
<td><code>D5</code></td>
<td>Volumen de recursos del quinto disco.</td>
</tr>
<tr>
<td>E</td>
<td><code>VOL.5</code></td>
<td>Identificador del quinto volumen de recursos.</td>
</tr>
</tbody>
</table>
<p>Tal como se indica en el <code>READ.ME</code>, el juego podía instalarse en disco sin problemas, reduciendo un poco los tiempos de carga y evitando la molestia de tener que andar cambiando de disco cada dos por tres.</p>
<p>Viendo los ficheros, al final lo que se le ocurre a uno es tan <em>&ldquo;simple&rdquo;</em> como extraer los ficheros de recursos de una versión española, buscar los textos en español y meterlos de vuelta en los volúmenes de recursos de cualquier versión para Atari ST.</p>
<h2 id="volúmenes-de-recursos">Volúmenes de recursos</h2>
<p>Como hemos visto, se usan diferentes ficheros para almacenar los recursos del juego. En el caso de <strong><em>Cruise for a Corpse</em></strong> tenemos 5 ficheros de volumen, 5 ficheros identificando dichos volúmenes y un fichero volumen <em>maestro</em> en el que hay un índice donde aparecen todos los ficheros de recursos en los 5 volúmenes.</p>
<p>La estructura de los ficheros de volumen es la siguiente:</p>
<p><img src="/cruise/vol_fmt.png" alt="Estructura de fichero de volumen"></p>
<p>En el caso del fichero <code>D1</code>, por ejemplo, la cabecera y la primera entrada serían tal que así:</p>
<p><img src="/cruise/d1_head.png" alt="Cabecera + primera entrada del fichero"></p>
<p>Podemos ver que en el fichero <code>D1</code> tiene un total de <code>0xA4</code> (164) entradas en el índice y que cada una de ellas se define en <code>0x1E</code> (30) bytes. Esto es así para cada una de las entradas del índice. La estructura de cada entrada es la siguiente (contando como base address el principio de la entrada):</p>
<p><img src="/cruise/entry_fmt.png" alt="Formato de cada entrada"></p>
<p>Por lo tanto, cada entrada quedaría así:</p>
<p><img src="/cruise/entry_fmt2.png" alt="Formato entrada 2"></p>
<p>En esta primera entrada como ejemplo podemos ver el nombre de fichero <code>AUTO00.OVL</code>, el offset (<code>0x0000133C</code>) el tamaño del fichero comprimido (<code>0x00000994</code> - 2452 bytes) y el tamaño del fichero descomprimido (<code>0x00001AC3</code> - 6851 bytes).</p>
<p>En cuanto al fichero <code>VOL.CNF</code>, tiene prácticamente la misma estructura que los ficheros de volumen de recursos, pero sólo contiene una entrada por cada fichero de volumen de datos (<code>D1</code>, <code>D2</code>, <code>D3</code>, <code>D4</code>, <code>D5</code>) y un índice general de ficheros sin tamaños ni offsets.</p>
<p>Al final esta es la parte fácil, ya que rebuscando un poco, uno encuentra que puede usarse el paquete de <code>scummvm-tools</code> para extraer todos los ficheros. Una vez descomprimido todo, vemos que los textos están en los ficheros con extensión <code>.FR</code>:</p>
<p><img src="/cruise/text_sample.png" alt="Muestra texto"></p>
<p>Cabe decir que no son ficheros de texto al uso. Comprobando <a href="https://github.com/scummvm/scummvm/tree/master/engines/cruise">el código de ScummVM sobre este motor</a> se puede ver como dichos ficheros se usan en conjunto con otros ficheros (<code>OVL</code> principalmente) sirven para &ldquo;montar&rdquo; el overlay de la escena. Esta capa, usando los ficheros <code>FR</code> y <code>OVL</code> correspondientes a cada escena, sirven para enlazar personajes/objetos/acciones/texto dentro de la escena, por lo que dentro de los ficheros <code>.FR</code> no sólo se encuentran las strings en español para el texto, también existen nombres de variables y objetos usados por el propio motor del juego.</p>
<p>Inicialmente lo que hice fue pensar en que tan solo encasquetando los ficheros <code>.FR</code> dentro del fichero de volumen y reconstruir el índice era suficiente, pero más adelante veremos que no.</p>
<p>En las siguientes líneas, me centraré en explicar la fase del reempaquetado de los volúmenes de recursos, así como el resto de cosillas que toqué para hacer que el invento funcione. Puesto que ya había conseguido descomprimir todos los recursos, tan sólo me quedaba la segunda parte y no tenía muy claro que esto fuera a salir adelante.</p>
<h2 id="reempaquetado">Reempaquetado</h2>
<p>Bien, lo primero que tenemos que hacer para volver a dejarlo todo como estaba, limpio como una patena y sin rastro de marraneo es averiguar el algoritmo de compresión que utilizó la gente de Delphine. Después de comentar el tema con <code>sev</code>, me dijo que el algoritmo no tenía mucho misterio, que se trataba de una modificación del archiconocido <a href="https://en.wikipedia.org/wiki/LZ77_and_LZ78">LZ77</a>. Al final, después de darle muchas vueltas, parece ser que el algoritmo utilizado era el que usaban muchos <em>crunchers</em> de la época (compresores): ByteKiller.</p>
<p>Después de todo el trabajo de investigación, me piqué una serie de herramientas que me permitían automatizar el proceso de paquetización. Estas herramientas se encargan de lo siguiente:</p>
<ol>
<li>
<p>Desempaquetar los volúmenes de recursos del directorio indicado al directorio destino.</p>
</li>
<li>
<p>Mover los ficheros con los textos en español al directorio destino.</p>
</li>
<li>
<p>Indexar qué ficheros corresponden a cada volumen.</p>
</li>
<li>
<p>Comprimir todos los ficheros.</p>
</li>
<li>
<p>Reconstruir el índice correspondiente al volumen con los siguientes datos:</p>
<ul>
<li>Nuevos offsets.</li>
<li>Nuevo tamaño comprimido.</li>
<li>Nuevo tamaño descomprimido.</li>
</ul>
</li>
<li>
<p>Reconstruir el volumen de datos con los nuevos ficheros.</p>
</li>
</ol>
<p>El fichero <code>VOL.CNF</code> no es necesario recrearlo debido a que no contiene información individual sobre los ficheros, por lo que no es necesario reflejar ninguno de los cambios realizados.</p>
<p>Una vez terminado el proceso, tan solo queda montar las imágenes de floppy nuevas. Para ello lo que hago es crear una imagen vacía desde <a href="http://hatari.tuxfamily.org/">Hatari</a> replicando los discos originales.</p>
<p>Una vez tengo las imágenes vacías, las edito con las <a href="http://hxc2001.free.fr/floppy_drive_emulator/index.html#download">herramientas de HxC</a> y añado los ficheros:</p>
<p><img src="/cruise/hxc_tools.PNG" alt="HxC Tools"></p>
<p>Acto seguido guardo la imagen en formato <code>.ST</code> y abro en el emulador:</p>
<p><img src="/cruise/emu_01.png" alt="Juego en español"></p>
<p>Bien, esta la imagen de arriba tiene trampa. Sí, os he engañado, esto no se acaba aquí. La captura anterior inicialmente se veía de la siguiente manera:</p>
<p><img src="/cruise/emu_initial.png" alt="Español inicial"></p>
<p>Fijaos que falta la <code>ú</code>. Después de investigar sobre el mapa de carácteres utilizado por Atari, probar a meter toda la tabla ASCII extendida en el texto y realizar mil y una pruebas sin resultado positivo, la respuesta estaba, de nuevo, <a href="https://github.com/scummvm/scummvm/blob/master/engines/cruise/staticres.cpp#L59">en el código de ScummVM</a>.</p>
<p>Parece ser que en los recursos del juego no se define un mapa de carácteres concreto. Debido a las características del motor, el mapa de carácteres que se usará, independientemente de si existe el caracter en <code>SYSTEM.FNT</code>, es el definido en el ejecutable del juego, en este caso el fichero <code>CRUISE.PRG</code>.</p>
<p>Dicho esto, puesto que tiene hardcodeada la tabla de carácteres correspondiente al idioma de la versión del juego, si queremos ver los textos en español en todo su esplendor no sólo hay que reconstruir los volúmenes de recursos. Tampoco es suficiente con copiar el fichero de la fuente bitmap de otra versión en español (<code>SYSTEM.FNT</code>). También hay que parchear el ejecutable del juego. Así que nada, manos a la obra!</p>
<p>Para que reconozca los nuevos carácteres, simpemente hay que parchear unos bytes en la parte donde está definida la tabla de carácteres. Aquí los cambios, donde <code>CRUISESP.PRG</code> es la versión parcheada y <code>CRUISEO.PRG</code> la original:</p>
<pre><code>$ radiff2 CRUISESP.PRG CRUISEO.PRG
0x0001ae3e 00720080 =&gt; ffffffff 0x0001ae3e
0x0001ae7c 007f0079007b008100820083 =&gt; ffffffffffffffffffffffff 0x0001ae7c
0x0001ae8c 007d =&gt; ffff 0x0001ae8c
0x0001ae96 007e =&gt; ffff 0x0001ae96
0x0001af14 00790078 =&gt; ffffffff 0x0001af14
0x0001af20 007b007a =&gt; ffffffff 0x0001af20
</code></pre><p>A continuación podéis todos los carácteres soportados en la versión francesa:</p>
<p><img src="/cruise/test_allchars_orig.png" alt="Francesa"></p>
<p>Y aquí podéis ver la tabla de carácteres del ejecutable parcheado, con sus ñÑ y sus cosicas:</p>
<p><img src="/cruise/test_allchars.png" alt="Española"></p>
<p>Todo esto nos vale para la versión original <em>sin cortar</em>, pero&hellip; ¿qué ocurre si tenemos una versión crackeada? Bien, pues podemos parchear de la misma manera. El único problema que tendremos es a la hora de descomprimir y volver a comprimir el ejecutable del juego. Para ello hará falta identificar el packer/cruncher utilizado:</p>
<p><img src="/cruise/mdepack.jpg" alt="Packed"></p>
<p>El ejecutable descomprimido tenía casi 4 veces el tamaño del ejecutable original (gracias a <strong><em>Tito Teclado</em></strong> por iluminarme el camino con las herramientas que me mandó). Esto es debido a la música, las fuentes para los scrollers, etc&hellip; todo lo que lleva una cracktro, vamos. En este caso tuve problemas a la hora de volver a montar el ejecutable, ya que si bien es cierto que arrancaba la cracktro sin problemas, a la hora de lanzar el juego se quedaba colgado. Seguramente había algún offset hardcodeado para saltar después de la cracktro que me cargué en el reempacado, así que no perdí mucho tiempo y me centré en la versión original sin crackear.</p>
<h2 id="todo">TODO:</h2>
<p>Temas pendientes:</p>
<ul>
<li>Intentar documentar el formato de los ficheros de texto y la relación con overlays (ficheros <code>.FR</code> y <code>.OVL</code>).</li>
<li>Generar y publicar una versión con los textos revisados y actualizados, acordes al 2020. Joaquín Ferrero (explorer) está en ello.</li>
<li>Generar y publicar una versión crackeada con su cracktro, musiquita y dibujutos. Para no andar con la ruedecita de protección todo el rato.</li>
</ul>
<h2 id="cierre-y-despedida">Cierre y despedida</h2>
<p>Lo explicado aquí es una versión bastante resumida de todas las pruebas que hice durante todo el proceso, me he limitado a ir bastante al grano para no aburrir (aunque creo que ni así lo he conseguido). De todas formas, si alguien quiere saber más, que pregunte :}</p>
<p>Para terminar, decir que independientemente de que haya existido o no la versión española del juego, he echado un ratito divertido, que es de lo que se trataba. Me quedo con lo siguiente:</p>
<ul>
<li>
<p>En la época no era extraño ver que los juegos utilizaban técnicas usadas en el mundillo demoscene. Como ejemplo pongo la compresión de los ficheros. ¿Qué fue antes, el huevo o la gallina?</p>
</li>
<li>
<p>Los sets de las escenas y los textos parece que no han cambiado nada entre diferentes plataformas / idiomas. Los textos de PC VGA y Amiga en español funcionan sin problemas en Atari ST.</p>
</li>
<li>
<p>He <em>aprendido</em> sobre algoritmos de compresión que no conocía. Sobre (de)crunchers/(un)packers de los 90 para Amiga y Atari ST.</p>
</li>
<li>
<p>Cada vez que me da por mirar cosas <em>antiguas</em> un poco a fondo, más las admiro. En los créditos del juego, en lo referente al core del desarrollo del juego (grafistas, sonido, programadores) aparecen un total <strong>8 personas diferentes</strong>. ¿Cuantas hacen falta hoy en día?</p>
</li>
<li>
<p>He escondido un easter egg en las versiones que reempaqueto para aquellos aventurados que quieran replicar todo este proceso. Es una tontería, pero he intentado emular aquello que hacían los grupos de crackers cuando destripaban algo :)</p>
</li>
</ul>
<p>La intención inicial era contribuir de alguna manera a la comunidad. Encima que llego casi 30 años tarde con una montaña de preguntas, quería hacer algo para, de alguna manera, devolver a la comunidad retro en general todas las cosas que me he llevado de una época que no fui capaz de disfrutar por edad, pero que a medida que descubría cosas nuevas, más me interesaba.</p>
<p>Espero que esto sirva como mi pequeño (y primer) aporte.</p>
<p>En breve colgaré las 5 imágenes de disco con los textos en español, basadas en la copia original francesa. Estas 5 imágenes llevan los textos en español tal cual se lanzaron en la época. Está sin adulterar: el texto íntegro de la narrativa y sin crackear.</p>
<p>Adicionalmente, si veo que hay suficiente interés, limpiaré el código y colgaré también las herramientas que he hecho para automatizar todo esto.</p>
<p>A disfrutar!</p>
<p><img src="/cruise/patched.png" alt="PATCHED!"></p>
<p><em>PS: Por favor, si has llegado hasta aquí y has visto algún error (crítico o no) en todo este galimatías de cosas que han salido de mi cabeza sin orden alguno, ponte en contacto conmigo para que pueda arrglarlo.</em></p>
			</div>
		</article>
	</main>
<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/posts/cruise_for_a_corpse_es/">[REL] Cruise for a Corpse - ES</a></li>
				
				<li><a href="/posts/cirugia-retro/">Cirugía Retro</a></li>
				
				<li><a href="/posts/back2biz/">BACK 2 BIZ</a></li>
				
			</ul>
		</div>
	</div>
</aside>


	<footer>
	<p>&copy; 2020 <a href="http://www.b0nk.com/"><b>b0nk&#39;s</b></a>.
	</p>
</footer>

</body>
</html>
